name: Upload Tracks from Issues

on:
  issues:
    types: [opened]

jobs:
  process_track:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug full event data
        run: |
          echo "üéØ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:"
          echo "${{ toJSON(github.event) }}"

      - name: Check for upload command
        id: check_upload
        run: |
          if echo "${{ github.event.issue.body }}" | grep -q "!upload"; then
            echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ !upload –Ω–∞–π–¥–µ–Ω–∞ –≤ Issue"
            echo "has_upload=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ !upload –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo "has_upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Get issue details via API
        if: steps.check_upload.outputs.has_upload == 'true'
        id: get_issue
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            console.log('üìã –î–∞–Ω–Ω—ã–µ Issue —á–µ—Ä–µ–∑ API:');
            console.log('Body:', issue.body);
            console.log('Attachments:', issue.attachments);
            
            return issue.attachments || [];

      - name: Create test file manually
        if: steps.check_upload.outputs.has_upload == 'true'
        run: |
          echo "üîÑ –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é..."
          mkdir -p tracks
          echo "–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ Issue #${{ github.event.issue.number }}" > "tracks/test_from_issue_${{ github.event.issue.number }}.txt"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add tracks/
          git commit -m "‚úÖ –¢–µ—Å—Ç: —Ñ–∞–π–ª –∏–∑ Issue #${{ github.event.issue.number }}"
          git push
          
          echo "üéâ –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"