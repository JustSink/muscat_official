name: Upload Tracks from Issues

on:
  issue_comment:
    types: [created]

jobs:
  process_track:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for upload command
        id: check_upload
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É !upload
          if echo "${{ github.event.comment.body }}" | grep -q "!upload"; then
            echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ !upload –Ω–∞–π–¥–µ–Ω–∞"
            echo "has_upload=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ !upload –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            echo "has_upload=false" >> $GITHUB_OUTPUT
          fi

      - name: Process audio file
        if: steps.check_upload.outputs.has_upload == 'true'
        env:
          ATTACHMENT_URL: ${{ github.event.comment.attachments[0].url }}
          FILENAME: ${{ github.event.comment.attachments[0].name }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          if [ -z "$ATTACHMENT_URL" ]; then
            echo "‚ùå –ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞!"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
          if ! echo "$FILENAME" | grep -E '\.(mp3|wav|ogg|m4a)$'; then
            echo "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: $FILENAME"
            exit 1
          fi

          echo "‚úÖ –ù–∞–π–¥–µ–Ω –∞—É–¥–∏–æ—Ñ–∞–π–ª: $FILENAME"
          echo "üì• –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: $ATTACHMENT_URL"

          # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É tracks –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p tracks

          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          wget -O "tracks/$FILENAME" "$ATTACHMENT_URL"
          echo "‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω: tracks/$FILENAME"

          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add tracks/
          git commit -m "üéµ –î–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫: $FILENAME"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          echo "üéâ –¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É!"

      - name: Skip non-upload
        if: steps.check_upload.outputs.has_upload == 'false'
        run: echo "‚ÑπÔ∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º - –Ω–µ—Ç –∫–æ–º–∞–Ω–¥—ã !upload"
