name: Upload Tracks from Issues

on:
  issue_comment:
    types: [created]

jobs:
  process_track:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Даём права на запись в репозиторий
      issues: read     # Права на чтение Issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find attached audio file
        id: find_file
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment;
            if (!comment.body.includes('!upload')) {
              console.log('Команда !upload не найдена');
              return '';
            }

            const attachment = comment.attachments?.[0];
            if (!attachment) {
              console.log('Нет прикреплённых файлов');
              return '';
            }

            if (!attachment.name.match(/\.(mp3|ogg|wav|m4a)$/i)) {
              console.log('Файл не аудио: ' + attachment.name);
              return '';
            }

            console.log('Найден аудиофайл: ' + attachment.name);
            return attachment.url;

      - name: Download and save track
        if: steps.find_file.outputs.result != ''
        run: |
          # Создаём папку tracks, если её нет
          mkdir -p tracks

          # Скачиваем файл
          FILENAME="track_$(date +%s).${steps.find_file.outputs.result##*.}"
          wget -O "tracks/$FILENAME" "${{ steps.find_file.outputs.result }}"

          # Коммитим изменения
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add tracks/
          git commit -m "[Auto] Добавлен трек из Issue #${{ github.event.issue.number }}"
          git push
