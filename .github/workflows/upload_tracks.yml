name: Upload Tracks from Issues

on:
  issue_comment:
    types: [created]

jobs:
  process_track:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find attached audio file
        id: find_file
        uses: actions/github-script@v6
        with:
          script: |
            const comment = context.payload.comment;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É upload
            if (!comment.body.includes('!upload')) {
              console.log('–ö–æ–º–∞–Ω–¥–∞ !upload –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
              return '';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–æ–∂–µ–Ω–∏—è
            const attachment = comment.attachments?.[0];
            if (!attachment) {
              console.log('–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤');
              return '';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
            if (!attachment.name.match(/\.(mp3|ogg|wav|m4a)$/i)) {
              console.log('–§–∞–π–ª –Ω–µ –∞—É–¥–∏–æ: ' + attachment.name);
              return '';
            }

            console.log('–ù–∞–π–¥–µ–Ω –∞—É–¥–∏–æ—Ñ–∞–π–ª: ' + attachment.name);
            return attachment.url;

      - name: Download and save track
        if: steps.find_file.outputs.result != ''
        run: |
          # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É tracks –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          mkdir -p tracks

          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
          FILENAME="track_$(date +%s).mp3"
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          echo "–°–∫–∞—á–∏–≤–∞—é —Ñ–∞–π–ª: ${{ steps.find_file.outputs.result }}"
          wget -O "tracks/$FILENAME" "${{ steps.find_file.outputs.result }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–∫–∞—á–∞–ª—Å—è
          if [ ! -f "tracks/$FILENAME" ]; then
            echo "–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –Ω–µ —Å–∫–∞—á–∞–ª—Å—è!"
            exit 1
          fi
          
          echo "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: tracks/$FILENAME"
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add tracks/
          git commit -m "[Auto] –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ç—Ä–µ–∫ –∏–∑ Issue"
          
          # –ü—É—à
          echo "–ó–∞–≥—Ä—É–∂–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub..."
          git push
          echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"

      - name: Success notification
        if: success()
        run: echo "üéµ Workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É."